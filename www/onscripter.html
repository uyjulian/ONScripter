<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
<TITLE> ONScripter のページ </TITLE>
<LINK rel="stylesheet" type="text/css" href="ogapee.css">
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#000080" VLINK="#800000" ALINK="#FF0000">

<CENTER>
<H1> ONScripter のページ </H1>
</CENTER>

Created: Feb. 6, 2002<br>
Last updated: Apr. 9, 2002

<HR>

<table>
<tr><th>はじめに</th></tr>
<tr><td>

<p>ONScripterとは、NScripter 用に作られたスクリプトを独自に解釈して実行するプログラムです。</p>

<p>NScripterは<a
href="http://www2.osk.3web.ne.jp/~naokikun/index.htm">高橋直樹</a>氏が開発したゲーム実行エンジンであり、高橋氏のホームページから<a href="http://www2.osk.3web.ne.jp/~naokikun/index.htm">ダウンロード</a>できます。</p>

<p>ONScripter で何ができるのかについてはαβεさんの[<A HREF="http://abe.platina.sakura.ne.jp/onscripter/">ONScripter のスゝメ</A>]を参照してください。</p>

<p>現在はベータ版<A HREF="onscripter-beta-20020409.tar.gz">onscripter-beta-20020409.tar.gz</A>を配布しております。<br>
ベータ版ゆえデバッグ出力が有効になっていますが、正式版になったら取り除きます。<br>
(一つ前のベータ版<A HREF="onscripter-beta-20020407.tar.gz">onscripter-beta-20020407.tar.gz</A>)</p>

<p>更新内容については[<A HREF="onscripter_devel.html">開発日誌</A>]を参照して下さい。</p>

<p>動作報告・バグ報告・機能追加要望・パッチは随時受け付けますので[<A HREF="http://abe.platina.sakura.ne.jp/kagemai/kagemai.rhtml?project=ONScripter">バグトラッキングシステム</A>]までお願いします。<br>
「○○ゲームの××場面がなんかおかしい」という程度でも結構ですのでお気軽にどうぞ。<br>
[<a href="mailto:ogapee@aqua.dti2.ne.jp">ogapee@aqua.dti2.ne.jp</a>]まで直接送っていただいても構いません。</p>

</td></tr><tr><td>
<P>
目次

<UL>
  <LI> <A HREF="#特徴"> 特徴 </A>
       <UL>
	 <LI> <A HREF="#NScripter と比較した特徴">NScripter と比較した特徴</A>
	 <LI> <A HREF="#実行環境としての特徴">実行環境としての特徴</A>
       </UL>
  <LI> <A HREF="#実行方法">実行方法</A>
       <UL>
	 <LI> <A HREF="#動作環境">動作環境</A>
	 <LI> <A HREF="#コンパイル">コンパイル</A>
	 <LI> <A HREF="#実行">実行</A>
       </UL>
  <LI> <A HREF="#TODO">TODO</A>
  <LI> <A HREF="#リンク">リンク</A>
  <LI> <A HREF="#雑多なこと">雑多なこと</A>
       <UL>
	 <LI> <A HREF="#キーボードショートカットについて">キーボードショートカットについて</A>
	 <LI> <A HREF="#起動オプションについて">起動オプションについて</A>
	 <LI> <A HREF="#レジストリ読み込みについて">レジストリ読み込みについて</A>
	 <LI> <A HREF="#音量及び変数編集モードについて">音量及び変数編集モードについて</A>
	 <LI> <A HREF="#TrueType font による漢字表示について">TrueType font による漢字表示について</A>
	 <LI> <A HREF="#CD audio 演奏の振り替えについて">CD audio 演奏の振り替えについて</A>
	 <LI> <A HREF="#MIDI 演奏機能について">MIDI 演奏機能について</A>
	 <LI> <A HREF="#Windows 上で MP3 の音がぶつぶつとぎれる問題について">Windows 上で MP3 の音がぶつぶつとぎれる問題について</A>
       </UL>
</UL>
</td></tr>
</table>


<A NAME="特徴"></A>
<table>
<tr><th> 特徴 </th></tr>
<tr><td>

<A NAME="NScripter と比較した特徴"></A>
<h3>NScripter と比較した特徴</h3>

<OL>
  <LI> 全ての操作をキーボードから行えます。もちろんマウスも使えますが、使う必要はありません。
  <LI> CD Audio の演奏に対応していますが、これを MP3 ファイルの演奏に振り替える機能もあります。
  <LI> マルチプラットフォームに対応しています。Windows, Linux, MacOS X での動作が確認されていますが、下記の libjpeg, bzip2, SDL 及び SMPEG が動く環境ならどこでも同じソースをコンパイルするだけで動くはずです。<BR>
  <LI> 全てのコマンド・仕様を実装していないため、ゲームによって挙動がおかしくなります。その場合は上記バグトラッキングシステムまで御報告下さい。
</OL>

</td></tr>
<tr><td>

<A NAME="実行環境としての特徴"></A>
<h3>実行環境としての特徴</h3>

<OL>
  <LI> セーブ・ロードができます(ただし、save?.dat は独自形式)。<BR>
  <LI> sar, nsa (nbz lzss を含む) アーカイブのデコードを実装しています。<BR>
  <LI> よく使われる画面効果（quake 系, 効果番号 1 - 15, 18）を実装しています。<BR>
  <LI> wav ファイル・MP3 ファイル・CD Audio・MIDI 演奏を実装しています。<BR>
  <LI> 右クリックメニュー（セーブ・ロード・回想・ウィンドウを消す・リセット・スキップ）を実装しています。<BR>
  <LI> カーソルのアニメーションを実装しています。<BR>
</OL>

</td></tr>
</table>

<A NAME="実行方法"></A>
<table>
<tr><th>実行方法</th></tr>
<tr><td>

<A NAME="動作環境"></A>
<h3>動作環境</h3>
<p> 下記のライブラリと処理系が必要です。バージョンは最新である必要はないかもしれませんが、他のバージョンでは確認していません。</p>

<DL>
  <DT> ・<A HREF="http://www.ijg.org/">Independent JPEG Group</A>
  <DD> libjpeg-6b
  <DT> ・<A HREF="http://sources.redhat.com/bzip2/">The bzip2 and libbzip2 official home page</A>
  <DD> bzip2-1.0.2
  <DT> ・<A HREF="http://www.libsdl.org">SDL (Simple Direct Layer)</A>
  <DD> SDL-1.2.3, SDL_image-1.2.1, SDL_mixer-1.2.1, SDL_ttf-2.0.4
  <DT> ・<A HREF="http://www.lokigames.com/development/smpeg.php3">SMPEG (SDL Mpeg Player Library)</A>
  <DD> SMPEG-0.4.4
  <DT> ・<A HREF="http://www.freetype.org/"> FreeType 2.0 </A>
  <DT> ・Unicode で指定された日本語 TTF フォント
  <DT> ・C++ 処理系
  <DD> Linux g++ 2.95.4
  <DD> Windows Visual C++ 6.0
</DL>
<p> 

<p> 当方では Windows と Linux で動作確認をしています。<BR>
また MacOS X での<A HREF="http://www.freeml.com/message/sdl-fan-jp@freeml.com/0000316">動作報告</A>を受けています。<br>

その他の多くの Unix 系 OS, BeOS, MacOS については上記のライブラリが対応しているため適切な Makefile を書けばコンパイル・実行できると思いますが、当方では確認できないので誰かやって下さい。</p>

<A NAME="コンパイル"></A>
<h3>コンパイル</h3>
<p>適当な場所に ONScripter を展開し、Linux の場合は make -f Makefile.Linux, Windows の場合は、nmake -f Makefile.Win とやって下さい。Windows の場合は、bzip2, SDL と SMPEG のヘッダファイルとライブラリのある場所を Makefile.Win で指定しているので、自身の環境に合わせて適宜修正してください。</p>

<A NAME="実行"></A>
<h3>実行</h3>
<p><FONT color="#ff0000">[必須]</FONT>まずゲームのアーカイブを一カ所にまとめます。通常は、スクリプト(0.txt もしくは nscript.dat)とアーカイブ(arc.sar もしくは arc.nsa)の２つのファイルがあれば十分なはずです。arc1.nsa 〜 arc9.nsa がある場合は、それも置いてください。またゲームによっては、アーカイブの外に一部の画像ファイルを置いていたりします。その場合は、それらのファイルも元と同じように置いてください。一番確実なのは、ディレクトリ毎全てのファイルをコピーしてくることです。</p>

<p><FONT color="#ff0000">[必須]</FONT>下記の&quot;TrueType font による漢字表示について&quot;を参考に、日本語 TrueType font を用意し、&quot;default.ttf&quot; という名前で置いてください。</p>

<p>[任意] CD audio の振り替え演奏をしたい場合は、下記の&quot;CD audio 演奏の振り替えについて&quot;に従って MP3 ファイルを用意してください。</p>

<p><FONT color="#ff0000">[必須]</FONT>最後に、ONScripter を実行してください。同じディレクトリにある nscript.dat とアーカイブを自動的に探し、ゲームが開始されます。なお ONScripter は、同じディレクトリにセーブデータやファイルログ等の状態ファイルを保存するため、このディレクトリには write permission を出しておいてください。</p>

</td></tr>
</table>

<A NAME="TODO"></A>
<table>
<tr><th>TODO</th></tr>
<tr><td>

<p>現在把握しており直す予定のバグ・未実装機能。先頭の文字は優先度。</p>

<OL>
  <LI> (<FONT color="#ff8800">中</FONT>)sprite の透明度サポート
  <LI> (<FONT color="#ff8800">中</FONT>)blt の拡大縮小に対応。
  <LI> (<FONT color="#ff8800">中</FONT>)雪をスムーズに降らせる
  <LI> (<FONT color="#ff8800">中</FONT>)立ち絵・スプライト・カーソルに汎用に使えるアニメーション機構の実装
  <LI> (<FONT color="#ff8800">中</FONT>)画像読み込み時の m 指定に対応。
  <LI> (<FONT color="#ff8800">中</FONT>)erasetextwindow off 時の選択画面での表示の正常化。
  <LI> (<FONT color="#ff8800">中</FONT>)quake 系で、時間がかかっても一周期につき２回は描画するようにする。
  <LI> (<FONT color="#ff8800">中</FONT>)quake 系で、テキスト表示時にはテキストを表示したまま揺れるようにする。
  <LI> (<FONT color="#00ff00">低</FONT>)save/load 時に確認画面を表示する
  <LI> (<FONT color="#00ff00">低</FONT>)archive の検索の高速化
  <LI> (<FONT color="#00ff00">低</FONT>)alpha blend が遅いのをなんとかしたい
  <LI> (<FONT color="#00ff00">低</FONT>)sprite の現在の表示 cell を保存する？
  <LI> (<FONT color="#00ff00">低</FONT>)skip でマイナス方向にラベルをまたぐと破綻するバグ？を取る。lchk とのからみも考えて調べる。
  <LI> (<FONT color="#00ff00">低</FONT>)voicevol, sevol, mp3vol の引数の扱いを確認。
  <LI> (<FONT color="#00ff00">低</FONT>)文字の色を変えたあとに絵の描画が入ると、文字の色が全部同じになってしまう。
  <LI> (<FONT color="#00ff00">低</FONT>)MacOS X の時に caption を UTF8 で書けるようにする。
  <LI> (<FONT color="#00ff00">低</FONT>)コードの clean up。
  <LI> (<FONT color="#000000">０</FONT>)textgosub 時に、同じ行で最初に変数を設定しその後テキストとして使用すると、設定がテキストに正確に反映されない。こんなトリッキーなことをするゲームが存在しないことを願う。
</OL>       

</td></tr>
</table>

<A NAME="リンク"></A>
<table>
<tr><th>リンク</th></tr>
<tr><td>

<p>お世話になっているページ、よく利用させていただいているページへのリンクです。</p>

<DL>
  <DT> ○<A HREF="http://chig.vis.ne.jp/m/port.html">娯楽用アプリケーションの異機種間データ共有の試み</A>
  <DD> 千熊屋さんによる様々なゲーム互換エンジンへのリンク集です。ONScripter も紹介していただいてます。
  <DT> ○<A HREF="http://abe.platina.sakura.ne.jp/onscripter/">ONScripter のスゝメ</A>
  <DD> αβεさんによる ONScripter の導入方法・既存のゲームの動作状況・バグ報告のページです。<br>
       ONScripter を開発する上でたいへんお世話になっております。<br>
       <A HREF="http://www.daifukuya.com/kagemai/">影舞</A>を利用した<A HREF="http://abe.platina.sakura.ne.jp/kagemai/kagemai.rhtml?project=ONScripter">バグトラッキングシステム</A>も運用していただいております。<br>
       ONScripter に興味を持たれた方は最初にこちらのページを見ることをお勧めします。
  <DT> ○<A HREF="http://www.geocities.co.jp/Berkeley/2093/">Adas's Linux ゲームプログラム</A>
  <DD> MacOS X で検証していただいている adas さんページです。<br>
       MacOS X 等に SDL をインストールする方法なども書かれています。
</DL>


</td></tr>
</table>

<A NAME="雑多なこと"></A>
<table>
<tr><th>雑多なこと</th></tr>
<tr><td>

<A NAME="キーボードショートカットについて"></A>
<h3>キーボードショートカットについて</h3>

<p> ONScripter は全ての操作をキーボードで行うことができます。下にショートカット一覧を書きます。</p>

<table>
<tr><td>キー</td><td>説明</td></tr>
<tr><td>space</td><td>マウスの左クリックと同じだが、下にボタンがあってもボタン外を押したことになる</td></tr>
<tr><td>return</td><td>マウスの左クリックと同じ</td></tr>
<tr><td>escape</td><td>マウスの右クリックと同じ</td></tr>
<tr><td>p, ↑</td><td>ボタン・文章選択時にマウスカーソルを前の選択肢に動かす</td></tr>
<tr><td>n, ↓</td><td>ボタン・文章選択時にマウスカーソルを次の選択肢に動かす</td></tr>
<tr><td> s </td><td>次の選択肢まで飛ばすモードに切り替え</td></tr>
<tr><td> o </td><td>１ページ表示をするかしないかの切り替え</td></tr>
<tr><td> z </td><td>--edit オプションを指定して起動したときに、音量及び変数変更モードに入る</td></tr>
<tr><td> 1, 2, 3 </td><td>文字の描画速度を変更</td></tr>
</table>

<p> ただし、s 以外のキーは入力待ちの時しか受け付けません（文字を描画している最中は受け付けません）。次の選択肢まで飛ばしている最中に限り、任意のタイミングで s キーにより通常の状態に戻すことができます。</p>

<p> また、コンソール画面で Ctl-c することで ONScripter を終了できます。その場合、グローバル変数等は保存されるので、終了する場合はゲームのメニューから終了するか、これで強制終了するかしてください。</p>

</td></tr><tr><td>

<A NAME="起動オプションについて"></A>
<h3>起動オプションについて</h3>

<p> 以下に示すオプションを指定できます。ただし、オプション無しがデフォルト動作です。</p>

<table>
<tr><td> オプション </td><td>説明</td></tr>
<tr><td>-h,--help</td><td>へルプを表示して終了。</td></tr>
<tr><td>-v,--version</td><td>バージョンを表示して終了。</td></tr>
<tr><td>--cdaudio</td><td>CD Audio 演奏モードに変更。CD Audio が使えなかったとしても MP3 ファイルは使用しません。</td></tr>
<tr><td>--font file</td><td>使用するフォントの path を指定。</td></tr>
<tr><td>--registry file</td><td>使用する registry file を指定。</td></tr>
<tr><td>--edit</td><td>z キーを押したときに、音量及び変数の編集モードに入れるようになる。</td></tr>
</table>

</td></tr><tr><td>

<A NAME="レジストリ読み込みについて"></A>
<h3>レジストリ読み込みについて</h3>

<p> getreg コマンドは Windows の registry から指定されたデータを取得し
ます。ONScripter では、テキストファイル registry.txt にデータを記述し、
これを読み込むことでこの機能を実現します。</p>

<P>registry.txt の書式は次の通りです。大文字・小文字は区別されます。ま
た余計なスペース等を入れないようにして下さい。漢字が使われている場合、
文字コードが Shift JIS になることに注意してください。</P>

<table border=1>
<TR><TD>
<pre>
[software\StudioOGA\ONScripter]
"INSTALL"="FULL"

[software\StudioOGA\のまど]
"Download log file"="c:\nomad_down.log"
"Upload log file"="c:\nomad_up.log"
</pre>
</TD></TR>
</table>

<P>ONScripter 起動時に --registry オプションを指定することで、
registry.txt を一カ所にまとめておくことができます。--registry を指定し
ない場合は、現在のディレクトリの registry.txt を読みにいきます。</P>


</td></tr><tr><td>

<A NAME="音量及び変数編集モードについて"></A>
<h3>音量及び変数編集モードについて</h3>

<p>これは暫定的なおまけ機能であり、今後変更されたり無くなったりする可能性があります。</p>

<P>ONScripter 起動時に --edit オプションを指定することで有効になります。</P>

<P>任意のキー入力待ち状態時に z キーを押すことで、編集モードに入ります。この時、title bar に<br>
<pre>
[EDIT MODE]  MP3 vol (m)  SE vol (s)  Voice vol (v)  Numeric variable (n)
</pre>

と表示されるはずです。この状態で、m, s, v, n のいずれかのキーを押すこ
とで、それぞれの値を変更するサブモードに入ります。また、Esc キーを押す
ことによってモードを抜けることができます。</P>

<P>数字変数の場合は、値変更の前にどの変数を変更するのかを選択します。</P>

<P>値変更サブモードでは、0 から 9 までの数字と -, BackSpace, Esc, リター
ンキーが使えます。- キーは、対象が数字変数でかつ数字が0の時のみ有効に
なります。既に数字が入力されている場合には、一旦 BackSpace で数字を全
部消してから - キーを押してください。</P>

</td></tr><tr><td>

<A NAME="TrueType font による漢字表示について"></A>
<h3>TrueType font による漢字表示について</h3>

<p> 漢字を表示するためには、TrueType font を用意する必要があります。例えば Windows 2000 では \WinNT\Fonts の下に msgothic.ttc があり、またフリーの TreuType font として、kochi-gothic.ttf や wadalab-gothic.ttf があります。<BR>

ここで注意しなければいけないのは、TrueType font によっては正常に漢字表示ができないということです。この原因は FreeType library か SDL_ttf の制約だと思いますが、以下に私が試した４つのフォントについて書きます。</p>

<DL>
  <DT> ＭＳゴシック (msgothic.ttc)
  <DD> embedded bitmap を使っており、ゲームで 22pt 以下のフォントを要求すると正常に表示できません。
  <DT> 東風ゴシックフォント (kochi-gothic.ttf)
  <DD> embedded bitmap を使っており、ゲームで 17pt 以下のフォントを要求すると正常に表示できません。
  <DT> 和田研ゴシック (wadalab-gothic.ttf)
  <DD> embedded bitmap は使っていませんが、UNICODE で記述されていないため使えません。
  <DT> HG ゴシック (hgrsmp.ttf)
  <DD> embedded bitmap は使っておらず、全てのサイズのフォントを正常に表示できます。
</DL>

<p> まとめると、UNICODE で記述されておりかつ embedded bitmap を使っていないフォント(上の例では HG ゴシック)が一番問題がなく、大きなフォントしか使わないゲームでは embedded bitmap が使用されていても使える(上の例では ＭＳゴシックや東風ゴシック)といったところです。</p>

<p> ONScripter を起動する前に、使用する TreuType font ファイルを、<STRONG>default.ttf</STRONG> という名前にしてゲームのスクリプトがある場所のコピーしておいてください。</p>

</td></tr><tr><td>

<A NAME="MIDI 演奏機能について"></A>
<h3>MIDI 演奏機能について</h3>

<p>MIDI は SDL_mixer の機能を使って演奏します。<br>
この時、現在のディレクトリに tmp.mid という一時ファイルを作ります。美しくないですが、SDL_mixer の MIDI 読み込み部がファイルからの読み込みしかサポートしていないためやむをえません。</p>

<DL>
  <DT> Windows もしくは MacOS X の場合。（MacOS X については当方未確認）
  <DD> OS の機能を使用して演奏するようなので、特に準備することはありません。
  <DT> Unix系(動作確認は Linux)でソフトウェア音源で演奏する場合（デフォルト）。
  <DD> SDL_mixer に取り込まれている timidity を使用してソフトウェア音源で演奏します。この場合、MIDIの音色データ<A HREF="http://www.libsdl.org/projects/SDL_mixer/timidity/timidity.tar.gz">timidity.tar.gz</A>をダウンロードして /usr/local/lib/ 以下に展開してください。
  <DT> Unix系(動作確認は Linux)で外部 MIDI 音源を利用して演奏する場合。
  <DD> playmidi 等の外部音源を使用できる MIDI player をインストールし、環境変数 MUSIC_CMD を設定してください。（例 MUSIC_CMD=/usr/bin/playmidi）<br>
       当方では、シリアル接続で外部音源を繋ぎ、MUSIC_CMD に '/usr/bin/midiplay -q -o /dev/ttyS0' を設定して動作確認をしています。<br>
       <A HREF="http://sourceforge.net/projects/playmidi/">playmidi</A>は、カーネルで認識される MIDI ポートに対してしか演奏できませんが、<A HREF="http://member.nifty.ne.jp/Breeze/softwares/unix/midiplay+.html">midiplay</A>はシリアルに直接出せます。<br>
       <A HREF="http://crystal.apana.org.au/ghansper/MidiAxis.html">シリアルポートをMIDIポートにする patch</A>を使えば、playmidi でもシリアル接続音源を使えそうですが、未確認です。       
</DL>

</td></tr><tr><td>

<A NAME="CD audio 演奏の振り替えについて"></A>
<h3>CD audio 演奏の振り替えについて</h3>

<p>ゲームのスクリプトがある場所に cd というディレクトリを作り、そこに<BR>
cd/track01.mp3<BR>
cd/track02.mp3<BR>
cd/track03.mp3<BR>
...<BR>
cd/track14.mp3<BR>
...<BR>
という名前で MP3 ファイルを置きます。</p>

<p>すると、スクリプトで CD audio の１曲目を演奏するコマンドがあった場合に、対応する track01.mp3 を演奏するようになります。</p>

<p>MP3 を必ず用意する必要はなく、その場合は音が鳴らないだけです。</p>

</td></tr><tr><td>

<A NAME="Windows 上で MP3 の音がぶつぶつとぎれる問題について"></A>
<h3>Windows 上で MP3 の音がぶつぶつとぎれる問題について</h3>

<P> Windows でコンパイル済の SMPEG のバイナリを持ってくると、MP3 によっては音がぶつぶつとぎれて演奏されます。これは、SMPEG を MSVC でコンパイルする時の最適化の問題で、下記の通りに MSVC の global optimization を一部抑制する指定をし、自分でコンパイルすることで解決できます。</P>


<PRE>
修正するファイル: audio/mpeglayer3.cpp
関数 layer3reorderandantialias の前後に、下のように #pragma 指定を追加する。

#pragma optimize( "g", off )
void MPEGaudio::layer3reorderandantialias(int ch,int gr,
					  REAL  in[SBLIMIT][SSLIMIT],
					  REAL out[SBLIMIT][SSLIMIT]){
  ......
}
#pragma optimize( "g", on )
</PRE>

</td></tr>
</table>

<A HREF="index.html">戻る</A>

<hr>
<center>
メール宛先 <a href="mailto:ogapee@aqua.dti2.ne.jp">ogapee@aqua.dti2.ne.jp</a> <BR>
Copyright (c) 1998-2002 Studio O.G.A. All rights reserved.
</center>

</BODY>
</HTML>

